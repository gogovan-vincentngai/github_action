
name: Build and Deploy to GKE

on:
  push:
    branches:
    - master

env:
  IMAGE: test
 
jobs:
  build:
    
    if: github.ref == 'refs/heads/master'
    env:
      CLOUDSDK_PYTHON_SITEPACKAGES: 1
      GKE_PROJECT: ${{ secrets.MASTER_GKE_PROJECT }}
      GKE_CLUSTER: ${{ secrets.MASTER_GKE_CLUSTER }}
      GKE_REGION: ${{ secrets.MASTER_GKE_REGION }}
      GKE_SA: ${{ secrets.MASTER_SA_EMAIL }}
      GKE_ACC_KEY: ${{ secrets.MASTER_GOOGLE_APPLICATION_CREDENTIALS }}
    
    runs-on: ubuntu-latest

    steps:
  
    - name: install python-openssl
      run: sudo apt-get install -y python-openssl -o=Dpkg::Use-Pty=0
    
    - name: Checkout
      uses: actions/checkout@v2    
    
    - name: Switch Cluster if Prod
      uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
      if: github.ref == 'refs/heads/master'
      with:
        version: '270.0.0'
        service_account_email: ${{ secrets.MASTER_SA_EMAIL }} 
        service_account_key: ${{ secrets.MASTER_GOOGLE_APPLICATION_CREDENTIALS }} 
        export_default_credentials: true

    - name: Switch Cluster if Dev
      if: github.ref == 'refs/heads/develop'
      with:
        version: '270.0.0'
        service_account_email: ${{ secrets.MASTER_SA_EMAIL }} 
        service_account_key: ${{ secrets.MASTER_GOOGLE_APPLICATION_CREDENTIALS }} 
        export_default_credentials: true
      
    - name: Login GKE
        gcloud auth configure-docker 
        gcloud info   
        
    
